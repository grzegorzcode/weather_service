<!DOCTYPE html>
<html lang="pl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Stacja Pogodowa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    screens: {
                        'landscape': {'raw': '(orientation: landscape)'},
                        'short': {'raw': '(max-height: 500px)'}
                    },
                    colors: {
                        stone: {
                            850: '#1f1c1a',
                            950: '#0c0a09',
                        }
                    },
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body { overflow: hidden; }
        .station-card { backdrop-filter: blur(10px); }
        .chart-wrapper { position: relative; width: 100%; height: 100%; overflow: hidden; }
        
        /* Animation for AQI pulse if bad */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .animate-pulse-red { animation: pulse-red 2s infinite; }
    </style>
</head>
<body class="bg-stone-200 dark:bg-black text-stone-900 dark:text-stone-100 font-sans h-screen w-screen flex flex-col items-center justify-center transition-colors duration-300 overflow-hidden">

    <!-- MAIN CONTAINER -->
    <main class="station-card w-[98%] h-[98%] md:w-[92%] md:h-[92%] bg-white dark:bg-stone-900 rounded-2xl md:rounded-3xl shadow-2xl overflow-hidden border-2 md:border-4 border-stone-300 dark:border-stone-800 flex flex-col relative">
        
        <!-- TOP BAR: Controls, AQI, 3-Day Forecast, Date -->
        <!-- Increased height slightly to accommodate new info -->
        <header class="flex justify-between items-center px-2 py-1 bg-stone-100 dark:bg-stone-950 border-b border-stone-300 dark:border-stone-800 shrink-0 h-16 md:h-20 gap-2">
            
            <!-- LEFT: City & AQI -->
            <div class="flex flex-col justify-center w-1/4 min-w-[120px]">
                <input type="text" id="city-input" value="Warszawa" 
                       class="bg-transparent font-bold text-lg md:text-2xl text-stone-800 dark:text-stone-200 w-full focus:outline-none placeholder-stone-400 uppercase tracking-widest truncate" aria-label="Miasto">
                
                <!-- AQI Badge -->
                <div id="aqi-badge" class="mt-1 inline-flex items-center gap-2 px-2 py-0.5 rounded-md bg-stone-200 dark:bg-stone-800 w-fit transition-all duration-500">
                    <span class="w-2 h-2 rounded-full bg-gray-400" id="aqi-dot"></span>
                    <div class="flex flex-col leading-none">
                        <span id="aqi-text" class="text-[9px] md:text-[10px] font-bold uppercase text-stone-500 dark:text-stone-400">Powietrze</span>
                        <span id="aqi-value" class="text-[10px] md:text-xs font-black text-stone-700 dark:text-stone-200">--%</span>
                    </div>
                </div>
            </div>

            <!-- CENTER: 3-Day Forecast -->
            <div id="forecast-container" class="flex-grow flex justify-center items-center gap-2 md:gap-6 px-2 border-l border-r border-stone-200 dark:border-stone-800 h-full">
                <!-- Days injected by JS -->
                <div class="text-xs text-stone-400">Ładowanie prognozy...</div>
            </div>
            
            <!-- RIGHT: Date & Theme -->
            <div class="flex flex-col items-end justify-center w-1/4 min-w-[100px] h-full">
                <div class="flex items-center gap-2 mb-1">
                     <button onclick="toggleTheme()" class="p-1 rounded-full bg-stone-300 dark:bg-stone-800 text-stone-800 dark:text-stone-200">
                        <svg id="icon-theme" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    </button>
                    <div id="current-date" class="text-[10px] md:text-xs font-bold uppercase tracking-widest text-stone-500 text-right leading-tight">...</div>
                </div>
                <div id="current-time-small" class="hidden md:block text-[10px] font-mono text-stone-400">--:--</div>
            </div>
        </header>

        <!-- MAIN DISPLAY GRID -->
        <div id="dashboard-content" class="flex-grow grid grid-cols-1 md:grid-cols-2 h-full overflow-hidden">
            
            <!-- LEFT PANEL -->
            <div class="flex flex-col justify-center items-center p-1 md:p-2 border-b md:border-b-0 md:border-r border-stone-300 dark:border-stone-800 relative bg-stone-50 dark:bg-stone-900/50">
                <button onclick="updateWeather()" class="absolute top-0 left-0 p-4 opacity-0 w-16 h-16 z-10" aria-label="Odśwież"></button>

                <div id="digital-clock" class="text-6xl md:text-8xl font-black font-mono tracking-tighter text-stone-800 dark:text-white leading-none mb-1 md:mb-4">
                    00:00
                </div>

                <div class="flex items-center justify-center gap-4 md:gap-10 mt-1 md:mt-2">
                    <div id="weather-icon-container" class="w-20 h-20 md:w-36 md:h-36 text-stone-700 dark:text-stone-200 shrink-0"></div>
                    <div class="flex flex-col leading-none">
                        <div class="flex items-start">
                            <span id="display-temp" class="text-7xl md:text-9xl font-black tracking-tighter text-stone-900 dark:text-white">--</span>
                            <span class="text-3xl md:text-5xl font-bold text-stone-500 dark:text-stone-400 mt-2 md:mt-4">°</span>
                        </div>
                    </div>
                </div>

                <div id="display-condition" class="text-lg md:text-3xl font-bold text-stone-500 dark:text-stone-300 mt-2 md:mt-6 uppercase tracking-widest text-center truncate w-full px-2">
                    Ładowanie...
                </div>
            </div>

            <!-- RIGHT PANEL -->
            <div class="flex flex-col h-full bg-white dark:bg-stone-900 overflow-hidden relative">
                <!-- 4-GRID METRICS -->
                <div class="grid grid-cols-2 h-[40%] border-b border-stone-300 dark:border-stone-800">
                    <div class="flex flex-col justify-center items-center border-r border-b border-stone-200 dark:border-stone-800 p-1 overflow-hidden">
                        <span class="text-stone-400 dark:text-stone-500 text-[9px] md:text-xs font-bold uppercase truncate">Odczuwalna</span>
                        <span id="metric-feels-like" class="text-xl md:text-3xl font-bold text-stone-700 dark:text-white truncate">--°</span>
                    </div>
                    <div class="flex flex-col justify-center items-center border-b border-stone-200 dark:border-stone-800 p-1 overflow-hidden">
                        <span class="text-stone-400 dark:text-stone-500 text-[9px] md:text-xs font-bold uppercase truncate">Wiatr</span>
                        <div class="flex items-baseline gap-1">
                            <span id="metric-wind" class="text-xl md:text-3xl font-bold text-stone-700 dark:text-white truncate">--</span>
                            <span class="text-xs md:text-sm font-bold text-stone-500">km/h</span>
                        </div>
                    </div>
                    <div class="flex flex-col justify-center items-center border-r border-stone-200 dark:border-stone-800 p-1 overflow-hidden">
                        <span class="text-stone-400 dark:text-stone-500 text-[9px] md:text-xs font-bold uppercase truncate">Wilgotność</span>
                        <span id="metric-humidity" class="text-xl md:text-3xl font-bold text-stone-700 dark:text-white truncate">--%</span>
                    </div>
                    <div class="flex flex-col justify-center items-center p-1 overflow-hidden">
                        <span class="text-stone-400 dark:text-stone-500 text-[9px] md:text-xs font-bold uppercase truncate">Opady</span>
                        <div class="flex items-baseline gap-1">
                            <span id="metric-precip" class="text-xl md:text-3xl font-bold text-stone-700 dark:text-white truncate">--</span>
                            <span class="text-xs md:text-sm font-bold text-stone-500">mm</span>
                        </div>
                    </div>
                </div>

                <!-- CHART AREA -->
                <div class="h-[60%] flex flex-col justify-center bg-stone-50 dark:bg-stone-900/30 pb-1 relative">
                    <div class="absolute top-1 left-3 right-3 flex justify-between items-center z-10 pointer-events-none">
                        <span class="text-[9px] font-bold uppercase text-stone-400">Temp</span>
                        <span class="text-[9px] font-bold uppercase text-blue-500">Opady</span>
                    </div>
                    <div class="chart-wrapper px-2 pb-5 pt-4">
                        <canvas id="weatherChart"></canvas>
                    </div>
                    <div id="last-updated" class="absolute bottom-1 right-2 text-[9px] font-mono text-stone-400 dark:text-stone-600">
                        Aktualizacja: --:--
                    </div>
                </div>
            </div>
        </div>
    </main>

    <input type="hidden" id="refresh-interval" value="15">

    <script>
        // --- HELPERS: Icons & Text ---
        function getWeatherIcon(code, isDay, size = "large") {
            const strokeColor = "currentColor";
            const strokeWidth = size === "small" ? 2 : 1.8;
            
            // Simplified paths for small icons
            const sun = `<svg viewBox="0 0 24 24" fill="none" stroke="${strokeColor}" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
            const moon = `<svg viewBox="0 0 24 24" fill="none" stroke="${strokeColor}" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
            const cloud = `<svg viewBox="0 0 24 24" fill="none" stroke="${strokeColor}" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>`;
            const cloudSun = `<svg viewBox="0 0 24 24" fill="none" stroke="${strokeColor}" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path><circle cx="12" cy="12" r="5" transform="translate(-8 -8) scale(0.6)"></circle></svg>`;
            const rain = `<svg viewBox="0 0 24 24" fill="none" stroke="${strokeColor}" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M16 13v6"></path><path d="M8 13v6"></path><path d="M12 15v6"></path><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg>`;
            const snow = `<svg viewBox="0 0 24 24" fill="none" stroke="${strokeColor}" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="8" y1="20" x2="8" y2="20"></line><line x1="12" y1="18" x2="12" y2="18"></line><line x1="12" y1="22" x2="12" y2="22"></line><line x1="16" y1="16" x2="16" y2="16"></line><line x1="16" y1="20" x2="16" y2="20"></line></svg>`;
            const thunder = `<svg viewBox="0 0 24 24" fill="none" stroke="${strokeColor}" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path><polyline points="13 11 9 17 15 17 11 23"></polyline></svg>`;
            const fog = `<svg viewBox="0 0 24 24" fill="none" stroke="${strokeColor}" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14h16"></path><path d="M4 18h16"></path><path d="M4 10h16"></path><path d="M4 6h16"></path></svg>`;

            if (code === 0) return isDay ? sun : moon;
            if (code >= 1 && code <= 3) return isDay ? cloudSun : cloud;
            if (code >= 45 && code <= 48) return fog;
            if (code >= 51 && code <= 67) return rain;
            if (code >= 71 && code <= 77) return snow;
            if (code >= 80 && code <= 82) return rain;
            if (code >= 95) return thunder;
            return cloud;
        }

        function getConditionText(code) {
            const codes = {
                0: "Czyste niebo", 1: "Lekkie zachm.", 2: "Część. zachm.", 3: "Pochmurno",
                45: "Mgła", 48: "Mgła", 51: "Mżawka", 53: "Mżawka", 55: "Mżawka",
                61: "Lekki deszcz", 63: "Deszcz", 65: "Ulewa", 71: "Śnieg", 73: "Śnieg",
                75: "Śnieżyca", 80: "Przelotny deszcz", 81: "Deszcz", 82: "Ulewa",
                95: "Burza", 96: "Burza", 99: "Silna burza"
            };
            return codes[code] || "Nieznane";
        }

        // --- THEME ---
        const htmlEl = document.documentElement;
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                htmlEl.classList.add('dark');
            } else {
                htmlEl.classList.remove('dark');
            }
        }
        function toggleTheme() {
            htmlEl.classList.toggle('dark');
            localStorage.theme = htmlEl.classList.contains('dark') ? 'dark' : 'light';
            if (weatherChartInstance && lastChartData) updateChart(lastChartData);
        }
        initTheme();

        // --- CORE APP ---
        let weatherChartInstance = null;
        let lastChartData = null;

        function updateClock() {
            const now = new Date();
            document.getElementById('digital-clock').textContent = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('current-date').textContent = now.toLocaleDateString('pl-PL', { weekday: 'short', day: 'numeric', month: 'long' });
            document.getElementById('current-time-small').textContent = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        async function fetchWeatherData(city) {
            const dashboard = document.getElementById('dashboard-content');
            try {
                dashboard.style.opacity = '0.7';
                
                // 1. Geocoding
                const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=pl&format=json`;
                const geoRes = await fetch(geoUrl);
                const geoData = await geoRes.json();
                
                if (!geoData.results?.length) throw new Error("Brak miasta");
                const { latitude: lat, longitude: lon, name } = geoData.results[0];

                // 2. Weather Data (Added daily forecast)
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weathercode,wind_speed_10m&hourly=temperature_2m,precipitation_probability&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=4`;
                const wRes = await fetch(weatherUrl);
                const wData = await wRes.json();

                // 3. Air Quality Data (Separate API)
                const airUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=pm10,pm2_5`;
                const airRes = await fetch(airUrl);
                const airData = await airRes.json();

                renderData({
                    location: `${name}`,
                    current: {
                        temp: Math.round(wData.current.temperature_2m),
                        feels_like: Math.round(wData.current.apparent_temperature),
                        humidity: wData.current.relative_humidity_2m,
                        wind: Math.round(wData.current.wind_speed_10m),
                        precip: wData.current.precipitation,
                        is_day: wData.current.is_day,
                        code: wData.current.weathercode
                    },
                    chart: {
                        labels: wData.hourly.time.slice(0, 24).map(t => t.slice(-5)),
                        temps: wData.hourly.temperature_2m.slice(0, 24),
                        probs: wData.hourly.precipitation_probability.slice(0, 24)
                    },
                    daily: wData.daily,
                    aqi: airData.current ? airData.current.pm10 : null // Using PM10 as basic reference
                });
                
                // Update Timestamp
                const now = new Date();
                document.getElementById('last-updated').textContent = `Aktualizacja: ${now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' })}`;
                
            } catch (e) {
                console.error(e);
            } finally {
                dashboard.style.opacity = '1';
            }
        }

        function renderData(data) {
            document.getElementById('city-input').value = data.location;
            document.getElementById('display-temp').textContent = data.current.temp;
            document.getElementById('display-condition').textContent = getConditionText(data.current.code);
            document.getElementById('weather-icon-container').innerHTML = getWeatherIcon(data.current.code, data.current.is_day === 1);
            document.getElementById('metric-feels-like').textContent = `${data.current.feels_like}°`;
            document.getElementById('metric-wind').textContent = `${data.current.wind}`;
            document.getElementById('metric-humidity').textContent = `${data.current.humidity}%`;
            document.getElementById('metric-precip').textContent = `${data.current.precip}`;

            // Render AQI
            renderAQI(data.aqi);

            // Render 3-Day Forecast
            renderForecast(data.daily);

            lastChartData = data.chart;
            updateChart(data.chart);
        }

        function renderAQI(pm10) {
            const badge = document.getElementById('aqi-badge');
            const dot = document.getElementById('aqi-dot');
            const text = document.getElementById('aqi-text');
            const val = document.getElementById('aqi-value');

            if (pm10 === null) {
                text.textContent = "Brak danych";
                return;
            }

            // Norm PM10 daily EU = 50 ug/m3
            const norm = 50;
            const percentage = Math.round((pm10 / norm) * 100);

            val.textContent = `${percentage}% normy`;

            badge.classList.remove('animate-pulse-red');

            if (percentage <= 50) {
                // Good
                dot.className = "w-2 h-2 rounded-full bg-green-500";
                text.textContent = "Dobre";
                text.className = "text-[9px] md:text-[10px] font-bold uppercase text-green-600 dark:text-green-400";
            } else if (percentage <= 100) {
                // Moderate
                dot.className = "w-2 h-2 rounded-full bg-yellow-500";
                text.textContent = "Średnie";
                text.className = "text-[9px] md:text-[10px] font-bold uppercase text-yellow-600 dark:text-yellow-400";
            } else {
                // Bad
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                text.textContent = "Złe";
                text.className = "text-[9px] md:text-[10px] font-bold uppercase text-red-600 dark:text-red-400";
                badge.classList.add('animate-pulse-red');
            }
        }

        function renderForecast(daily) {
            const container = document.getElementById('forecast-container');
            container.innerHTML = ''; // Clear

            const days = ['Ndz', 'Pon', 'Wt', 'Śr', 'Czw', 'Pt', 'Sob'];
            
            // Loop for next 3 days (indices 1, 2, 3)
            for (let i = 1; i <= 3; i++) {
                const date = new Date(daily.time[i]);
                const dayName = days[date.getDay()];
                const code = daily.weathercode[i];
                const max = Math.round(daily.temperature_2m_max[i]);
                const min = Math.round(daily.temperature_2m_min[i]);

                const div = document.createElement('div');
                div.className = "flex flex-col items-center justify-center w-12 md:w-16";
                div.innerHTML = `
                    <span class="text-[9px] md:text-[10px] font-bold uppercase text-stone-500 dark:text-stone-400 mb-0.5">${dayName}</span>
                    <div class="w-6 h-6 md:w-8 md:h-8 text-stone-700 dark:text-stone-300">
                        ${getWeatherIcon(code, true, "small")}
                    </div>
                    <div class="text-[9px] md:text-[10px] font-bold text-stone-700 dark:text-stone-200 mt-0.5 leading-none">
                        ${max}°<span class="text-stone-400">/</span>${min}°
                    </div>
                `;
                container.appendChild(div);
            }
        }

        function updateChart(data) {
            if (!data) return;
            const ctx = document.getElementById('weatherChart').getContext('2d');
            if (weatherChartInstance) weatherChartInstance.destroy();

            const isDark = htmlEl.classList.contains('dark');
            const colorLine = '#ea580c'; 
            const colorBar = '#3b82f6';
            const colorText = isDark ? '#d6d3d1' : '#57534e'; 
            const colorGrid = isDark ? '#292524' : '#e5e7eb';
            
            const isSmallScreen = window.innerHeight < 500;
            const fontSize = isSmallScreen ? 10 : 11;

            const steps = 3; 
            const filteredLabels = data.labels.filter((_, i) => i % steps === 0);
            const filteredTemps = data.temps.filter((_, i) => i % steps === 0);
            const filteredProbs = data.probs.filter((_, i) => i % steps === 0);

            weatherChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filteredLabels,
                    datasets: [
                        {
                            type: 'line',
                            label: 'Temp',
                            data: filteredTemps,
                            borderColor: colorLine,
                            borderWidth: isSmallScreen ? 2 : 3,
                            pointRadius: isSmallScreen ? 2 : 0,
                            pointBackgroundColor: colorLine,
                            tension: 0.4,
                            yAxisID: 'y',
                            order: 1
                        },
                        {
                            type: 'bar',
                            label: 'Opady (%)',
                            data: filteredProbs,
                            backgroundColor: colorBar,
                            borderRadius: 2,
                            yAxisID: 'y1',
                            barThickness: isSmallScreen ? 6 : 10,
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            bottom: 5 
                        }
                    },
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: colorText, 
                                font: { size: fontSize, weight: 'bold' } 
                            }
                        },
                        y: {
                            display: true,
                            position: 'left',
                            grid: { color: colorGrid },
                            ticks: { 
                                color: colorText, 
                                font: { size: fontSize, weight: 'bold' },
                                callback: function(value) { return value + '°'; }
                            }
                        },
                        y1: {
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            grid: { display: false },
                            ticks: { 
                                color: colorBar, 
                                font: { size: fontSize - 1, weight: 'bold' }, 
                                stepSize: 50,
                                callback: function(value) { return value + '%'; }
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('city-input').addEventListener('change', function() {
            fetchWeatherData(this.value);
        });
        fetchWeatherData(document.getElementById('city-input').value);
        setInterval(function() { fetchWeatherData(document.getElementById('city-input').value); }, 15 * 60 * 1000);

    </script>
</body>
</html>
